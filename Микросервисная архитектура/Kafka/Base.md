> Apache Kafka — система публикации сообщений и подписки на них, предназначенная для решения поставленной задачи

Используемая в Kafka единица данных называется сообщением (**==message==** - массив байтов). В сообщении может быть дополнительный элемент метаданных, называемый ключом (**==key==** - тоже массив байт)

Для большей эффективности сообщения в Kafka записываются пакетами. Пакет (==**batch**==) представляет собой просто набор сообщений, относящихся к одной теме и одному разделу.

[[Apache AVRO]]

%% Хотя сообщения для Kafka — всего лишь непрозрачные массивы байтов, рекоменду-
ется накладывать на содержимое сообщений дополнительную структуру — схему,
которая позволяла бы с легкостью их разбирать %%

Сообщения в Kafka распределяются по темам ((==**topics**==, иногда называют топиками).  Темы в свою очередь разбиваются на разделы (==**partitions**==)

**Представление темы с несколькими разделами**
![[Pasted image 20250519222116.png]]

При обсуждении данных, находящихся в таких системах, как Kafka, часто используется термин поток данных (***stream***). Чаще всего поток данных считается отдельной темой, независимо от количества разделов представляющей собой отдельный поток данных, перемещающихся от производителей к потребителям.

/////

Пользователи Kafka делятся на два основных типа: **производители** (генераторы) и **потребители**
Производители (==**producers**==) генерируют новые сообщения. В других системах обмена сообщениями по типу «публикация/подписка» их называют издателями (**==publishers==**) или авторами (==**writers**==). В целом производители сообщений создают их для конкретной темы.

%% По умолчанию производителю не важно, в какой раздел
записывается конкретное сообщение, он будет равномерно
поставлять сообщения во все разделы темы. %%

Потребители (**==consumers==**) читают сообщения. В других системах обмена сообщениями по типу «публикация/подписка» их называют подписчиками (**==subscribers==**) или читателями (**==readers==**). ***==Потребитель подписывается на одну тему или более и читает сообщения в порядке их создания==***

Он отслеживает, какие сообщения он уже прочитал, запоминая смещение сообщений. Смещение (**==offset==**) (непрерывно возрастающее целочисленное значение) — еще один элемент метаданных, который Kafka добавляет в каждое сообщение при генерации.

Потребители работают в составе групп потребителей (**==consumer groups==**) — одного или нескольких потребителей, объединившихся для обработки темы

**Чтение темы группой потребителей**
![[Pasted image 20250519223621.png]]


# Брокеры и кластеры
Отдельный сервер Kafka называется брокером (broker). Брокер получает сообщения от производителей, присваивает им смещения и отправляет их в дисковое хранилище

@todo https://habr.com/ru/companies/slurm/articles/535374/

%% В зависимости от конкретного
аппаратного обеспечения и его производительности отдельный брокер может с лег-
костью обрабатывать тысячи разделов и миллионы сообщений в секунду. %%

> Брокеры Kafka предназначены для работы в составе кластера (cluster). Один из брокеров кластера функционирует в качестве контроллера (cluster controller). Контроллер кластера выбирается автоматически из числа работающих членов кластера. Контроллер отвечает за административные операции, включая распределение разделов по брокерам и мониторинг отказов последних. Каждый раздел принадлежит одному из брокеров кластера, который называется его ведущим (leader).

![[Pasted image 20250519224251.png]]


## Основные настройки брокера

 1. ***broker.id*** - У каждого брокера Kafka должен быть целочисленный идентификатор, задаваемый посредством параметра broker.id. По умолчанию это значение равно 0, но может быть любым числом
 2. ***port*** - Типовой файл конфигурации запускает Kafka с прослушивателем на TCP-порту. Этот порт можно изменить на любой другой доступный путем изменения параметра конфигурации port
 3. ***zookeeper.connect*** -  Путь, который ZooKeeper использует для хранения метаданных брокеров, задается с помощью параметра конфигурации zookeeper.connect:
		Формат - hostname:port/path
			1. hostname — имя хоста или IP-адрес сервера ZooKeeper;
			2. port — номер порта клиента для сервера;
			3. /path — необязательный путь ZooKeeper, используемый в качестве нового корневого (chroot) пути кластера Kafka. Если он не задан, используется корневой
				путь.
4. ***log.dirs*** - Kafka сохраняет все сообщения на жесткий диск, и хранятся эти сегменты журналов в каталогах, задаваемых в настройке log.dirs . Она представляет собой разделенный запятыми список путей в локальной системе. Если задано несколько путей, брокер будет сохранять разделы в них по принципу наименее используемых, с сохранением сегментов журналов одного раздела по одному пути. Отметим, что брокер поместит новый раздел в каталог, в котором в настоящий момент хранится меньше всего разделов, а не используется меньше всего пространства, так что равномерное распределение данных по разделам не гарантируется.
5. ***num.recovery.threads.per.data.dir*** - Для обработки сегментов журналов Kafka использует настраиваемый пул потоков выполнения
6. ***auto.create.topics.enable*** - В соответствии с конфигурацией Kafka по умолчанию брокер должен автоматически создавать тему, когда:
	производитель начинает писать в тему сообщения;
	потребитель начинает читать из темы сообщения;
	любой клиент запрашивает метаданные темы.
	Если вы управляете созданием тем явным образом, вручную или посредством системы инициализации, то можете установить для параметра auto.create.topics.enable значение false
7. ***num.partitions*** - Параметр num.partitions определяет, с каким количеством разделов создается новая тема, главным образом в том случае, когда включено автоматическое создание тем (что является поведением по умолчанию). Значение этого параметра по-умолчанию — 1
8. ***log.retention.ms*** - Чаще всего продолжительность хранения сообщений в Kafka ограничивается по времени. Значение по умолчанию указано в файле конфигурации с помощью параметра log.retention.hours и равно 168 часам, или 1 неделе

%% Хранение информации в течение заданного промежутка времени осуществля-
ется путем анализа времени последнего изменения (mtime) каждого из файлов
сегментов журналов на диске. При обычных обстоятельствах оно соответствует
времени закрытия сегмента журнала и отражает метку даты/времени последнего
сообщения в файле. Однако при использовании инструментов администратора
для переноса разделов между брокерами это время оказывается неточным
и приводит к слишком длительному хранению информации для этих разделов. %%

Еще один способ ограничения срока действия сообщений — на основе общего размера (в байтах) сохраняемых сообщений. Значение задается с помощью параметра log.retention.bytes и применяется пораздельно

9. ***message.max.bytes*** - Брокер Kafka позволяет с помощью параметра message.max.bytes ограничивать максимальный размер генерируемых сообщений. Значение этого параметра по
умолчанию равно 1 000 000 (1 Мбайт). Производитель, который попытается отправить сообщение большего размера, получит от брокера извещение об ошибке, а сообщение принято не будет. Как и в случае всех остальных размеров в байтах, указываемых в настройках брокера, речь идет о размере сжатого сообщения, так что производители могут отправлять сообщения, размер которых в несжатом виде гораздо больше, если их можно сжать до задаваемых параметром message.max.bytes пределов.

## Выбор аппаратного обеспечения